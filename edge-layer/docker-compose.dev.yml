# Development overrides for edge services
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ============================================
  # EDGE INFRASTRUCTURE
  # ============================================
  postgres:
    image: postgres:16-alpine
    # container_name: farmiq-edge-postgres
    ports:
      - "5141:5432" # Different port from cloud (5140)
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-farmiq}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-farmiq_dev}
      - POSTGRES_DB=${POSTGRES_DB:-farmiq}
    volumes:
      - edge_postgres_data:/var/lib/postgresql/data
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-farmiq}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    #container_name: farmiq-edge-minio
    ports:
      - "9000:9000" # MinIO API
      - "9001:9001" # MinIO Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - edge_minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      start_period: 40s
      retries: 3

  # ============================================
  # EDGE SERVICE OVERRIDES
  # ============================================
  edge-cloud-ingestion-mock:
    build:
      context: ./edge-cloud-ingestion-mock
      dockerfile: Dockerfile.dev
    ports:
      - "5102:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
    networks:
      - farmiq-net

  edge-mqtt-broker:
    build:
      context: ./edge-mqtt-broker
      dockerfile: Dockerfile.dev
    ports:
      - "5100:1883"
    networks:
      - farmiq-net

  edge-ingress-gateway:
    build:
      context: ./edge-ingress-gateway
      dockerfile: Dockerfile.dev
    ports:
      - "5103:3000"
    volumes:
      - ./edge-ingress-gateway/src:/usr/src/app/src:ro
      - ./edge-ingress-gateway/prisma:/usr/src/app/prisma:ro
      - ./edge-ingress-gateway/package.json:/usr/src/app/package.json:ro
      - ./edge-ingress-gateway/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-ingress-gateway/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MQTT_BROKER_URL=mqtt://edge-mqtt-broker:1883
      - EDGE_TELEMETRY_TIMESERIES_URL=http://edge-telemetry-timeseries:3000
      - EDGE_WEIGHVISION_SESSION_URL=http://edge-weighvision-session:3000
      - DOWNSTREAM_TIMEOUT_MS=5000
      - DEDUPE_TTL_MS=259200000
      - DEDUPE_CLEANUP_INTERVAL_MS=60000
    networks:
      - farmiq-net

  edge-telemetry-timeseries:
    build:
      context: ./edge-telemetry-timeseries
      dockerfile: Dockerfile.dev
    ports:
      - "5104:3000"
    volumes:
      - ./edge-telemetry-timeseries/src:/usr/src/app/src:ro
      - ./edge-telemetry-timeseries/prisma:/usr/src/app/prisma:ro
      - ./edge-telemetry-timeseries/package.json:/usr/src/app/package.json:ro
      - ./edge-telemetry-timeseries/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-telemetry-timeseries/tsconfig.prisma.json:/usr/src/app/tsconfig.prisma.json:ro
      - ./edge-telemetry-timeseries/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
    networks:
      - farmiq-net

  edge-weighvision-session:
    build:
      context: ./edge-weighvision-session
      dockerfile: Dockerfile.dev
    ports:
      - "5105:3000"
    volumes:
      - ./edge-weighvision-session/src:/usr/src/app/src:ro
      - ./edge-weighvision-session/prisma:/usr/src/app/prisma:ro
      - ./edge-weighvision-session/package.json:/usr/src/app/package.json:ro
      - ./edge-weighvision-session/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-weighvision-session/tsconfig.prisma.json:/usr/src/app/tsconfig.prisma.json:ro
      - ./edge-weighvision-session/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
    networks:
      - farmiq-net

  edge-media-store:
    build:
      context: ./edge-media-store
      dockerfile: Dockerfile.dev
    ports:
      - "5106:3000"
    volumes:
      - ./edge-media-store/src:/usr/src/app/src:ro
      - ./edge-media-store/prisma:/usr/src/app/prisma:ro
      - ./edge-media-store/package.json:/usr/src/app/package.json:ro
      - ./edge-media-store/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-media-store/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MEDIA_ENDPOINT=${MEDIA_ENDPOINT:-http://minio:9000}
      - MEDIA_PRESIGN_ENDPOINT=${MEDIA_PRESIGN_ENDPOINT:-http://localhost:9000}
      - MEDIA_ACCESS_KEY=${MEDIA_ACCESS_KEY:-minioadmin}
      - MEDIA_SECRET_KEY=${MEDIA_SECRET_KEY:-minioadmin}
      - MEDIA_REGION=${MEDIA_REGION:-us-east-1}
      - MEDIA_BUCKET=${MEDIA_BUCKET:-farmiq-media}
      - MEDIA_BUCKET_AUTO_CREATE=true
    networks:
      - farmiq-net

  edge-vision-inference:
    build:
      context: ./edge-vision-inference
      dockerfile: Dockerfile.dev
    ports:
      - "5107:8000"
    volumes:
      - ./edge-vision-inference/app:/app/app:ro
    environment:
      - LOG_LEVEL=DEBUG
      - MEDIA_STORE_URL=http://edge-media-store:3000
    networks:
      - farmiq-net

  edge-sync-forwarder:
    build:
      context: ./edge-sync-forwarder
      dockerfile: Dockerfile.dev
    volumes:
      - ./edge-sync-forwarder/src:/usr/src/app/src:ro
      - ./edge-sync-forwarder/package.json:/usr/src/app/package.json:ro
      - ./edge-sync-forwarder/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-sync-forwarder/openapi.yaml:/usr/src/app/openapi.yaml:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - RUN_MODE=${RUN_MODE:-integration}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - CLOUD_INGESTION_URL=${CLOUD_INGESTION_URL:-http://host.docker.internal:5300/api/v1/edge/batch}
      - CLOUD_INGESTION_URL_REQUIRED=${CLOUD_INGESTION_URL_REQUIRED:-true}
      - CLOUD_AUTH_MODE=${CLOUD_AUTH_MODE:-none}
      - CLOUD_API_KEY=${CLOUD_API_KEY:-}
      - CLOUD_HMAC_SECRET=${CLOUD_HMAC_SECRET:-}
      - OUTBOX_MAX_ATTEMPTS=${OUTBOX_MAX_ATTEMPTS:-10}
      - INTERNAL_ADMIN_ENABLED=${INTERNAL_ADMIN_ENABLED:-true}
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  edge-observability-agent:
    build:
      context: ./edge-observability-agent
      dockerfile: Dockerfile.dev
    ports:
      - "5111:3000"
    volumes:
      - ./edge-observability-agent/src:/usr/src/app/src:ro
      - ./edge-observability-agent/package.json:/usr/src/app/package.json:ro
      - ./edge-observability-agent/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-observability-agent/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DISK_PATH=/
      - EDGE_INGRESS_URL=http://edge-ingress-gateway:3000
      - EDGE_TELEMETRY_URL=http://edge-telemetry-timeseries:3000
      - EDGE_WEIGHVISION_URL=http://edge-weighvision-session:3000
      - EDGE_VISION_URL=http://edge-vision-inference:8000
      - EDGE_MEDIA_URL=http://edge-media-store:3000
      - EDGE_SYNC_URL=http://edge-sync-forwarder:3000
    networks:
      - farmiq-net

  edge-policy-sync:
    build:
      context: ./edge-policy-sync
      dockerfile: Dockerfile.dev
    ports:
      - "5109:3000"
    volumes:
      - ./edge-policy-sync/src:/usr/src/app/src:ro
      - ./edge-policy-sync/package.json:/usr/src/app/package.json:ro
      - ./edge-policy-sync/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-policy-sync/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - BFF_BASE_URL=http://host.docker.internal:5125
    networks:
      - farmiq-net

  edge-retention-janitor:
    build:
      context: ./edge-retention-janitor
      dockerfile: Dockerfile.dev
    ports:
      - "5115:3000"
    volumes:
      - ./edge-retention-janitor/src:/usr/src/app/src:ro
      - ./edge-retention-janitor/prisma:/usr/src/app/prisma:ro
      - ./edge-retention-janitor/package.json:/usr/src/app/package.json:ro
      - ./edge-retention-janitor/tsconfig.json:/usr/src/app/tsconfig.json:ro
      - ./edge-retention-janitor/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - LOG_LEVEL=debug
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
    networks:
      - farmiq-net

  edge-ops-web:
    build:
      context: ./edge-ops-web
      dockerfile: Dockerfile
    # container_name: farmiq-edge-ops-web
    ports:
      - "5113:80"
    environment:
      - VITE_TENANT_ID=${VITE_TENANT_ID:-t-001}
      - VITE_CONNECTION_PROFILE=${VITE_CONNECTION_PROFILE:-local}
      - VITE_EDGE_HOST=${VITE_EDGE_HOST:-192.168.1.50}
      - VITE_AUTH_MODE=${VITE_AUTH_MODE:-none}
      - VITE_API_KEY=${VITE_API_KEY:-}
      - VITE_HMAC_SECRET=${VITE_HMAC_SECRET:-}
      - VITE_INGRESS_GATEWAY_URL=${VITE_INGRESS_GATEWAY_URL:-http://edge-ingress-gateway:3000}
      - VITE_TELEMETRY_URL=${VITE_TELEMETRY_URL:-http://edge-telemetry-timeseries:3000}
      - VITE_WEIGHVISION_URL=${VITE_WEIGHVISION_URL:-http://edge-weighvision-session:3000}
      - VITE_MEDIA_URL=${VITE_MEDIA_URL:-http://edge-media-store:3000}
      - VITE_VISION_URL=${VITE_VISION_URL:-http://edge-vision-inference:8000}
      - VITE_SYNC_URL=${VITE_SYNC_URL:-http://edge-sync-forwarder:3000}
      - VITE_OBSERVABILITY_URL=${VITE_OBSERVABILITY_URL:-http://edge-observability-agent:3000}
      - VITE_POLICY_SYNC_URL=${VITE_POLICY_SYNC_URL:-http://edge-policy-sync:3000}
      - VITE_FEED_INTAKE_URL=${VITE_FEED_INTAKE_URL:-http://edge-feed-intake:5109}
    networks:
      - farmiq-net
    # Dev override: avoid pulling/building the whole stack when running
    # `docker compose ... up --build edge-ops-web` in restricted-network environments.
    depends_on: []

  # NOTE: Some developer workspaces do not have ./edge-feed-intake checked out.
  # Mark as optional so `docker compose up` won't try to build it.
  edge-feed-intake:
    profiles: ["feed-intake"]
    build:
      context: ./edge-feed-intake
      dockerfile: Dockerfile.dev
    # container_name: farmiq-edge-feed-intake
    ports:
      - "5116:5109"
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - APP_PORT=5109
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MQTT_BROKER_URL=mqtt://edge-mqtt-broker:1883
      - MQTT_CLIENT_ID=edge-feed-intake
      - DD_SERVICE=edge-feed-intake
      - DD_ENV=development
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      edge-mqtt-broker:
        condition: service_started

networks:
  farmiq-net:
    driver: bridge

volumes:
  edge_postgres_data:
  edge_mqtt_data:
  edge_mqtt_log:
  edge_minio_data:
