version: '3.8'

services:
  # ============================================
  # EDGE SERVICES
  # ============================================
  edge-mqtt-broker:
    build:
      context: ./edge-mqtt-broker
      dockerfile: Dockerfile
    container_name: farmiq-edge-mqtt
    ports:
      - "5100:1883"
    volumes:
      - ./edge-mqtt-broker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-t", "$$SYS/health", "-C", "1"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-ingress-gateway:
    build:
      context: ./edge-ingress-gateway
      dockerfile: Dockerfile
    container_name: farmiq-edge-ingress-gateway
    ports:
      - "5103:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MQTT_BROKER_URL=mqtt://edge-mqtt-broker:1883
      - EDGE_TELEMETRY_TIMESERIES_URL=http://edge-telemetry-timeseries:3000
      - EDGE_WEIGHVISION_SESSION_URL=http://edge-weighvision-session:3000
      - DOWNSTREAM_TIMEOUT_MS=5000
      - DEDUPE_TTL_MS=259200000
      - DEDUPE_CLEANUP_INTERVAL_MS=60000
      - DD_SERVICE=edge-ingress-gateway
      - DD_ENV=development
    depends_on:
      edge-mqtt-broker:
        condition: service_started
      edge-telemetry-timeseries:
        condition: service_started
      edge-weighvision-session:
        condition: service_started
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-telemetry-timeseries:
    build:
      context: ./edge-telemetry-timeseries
      dockerfile: Dockerfile
    container_name: farmiq-edge-telemetry-timeseries
    ports:
      - "5104:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_SERVICE=edge-telemetry-timeseries
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-weighvision-session:
    build:
      context: ./edge-weighvision-session
      dockerfile: Dockerfile
    container_name: farmiq-edge-weighvision-session
    ports:
      - "5105:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_SERVICE=edge-weighvision-session
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-media-store:
    build:
      context: ./edge-media-store
      dockerfile: Dockerfile
    container_name: farmiq-edge-media-store
    ports:
      - "5106:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MEDIA_STORAGE_PATH=/data/media
      - DD_SERVICE=edge-media-store
      - DD_ENV=development
    volumes:
      - ../../data/edge-media:/data/media
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-vision-inference:
    build:
      context: ./edge-vision-inference
      dockerfile: Dockerfile
    container_name: farmiq-edge-vision-inference
    ports:
      - "5107:8000"
    environment:
      - LOG_LEVEL=INFO
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MEDIA_STORAGE_PATH=/data/media
      - DD_SERVICE=edge-vision-inference
      - DD_ENV=development
    volumes:
      - ../../data/edge-media:/data/media:ro
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-sync-forwarder:
    build:
      context: ./edge-sync-forwarder
      dockerfile: Dockerfile
    container_name: farmiq-edge-sync-forwarder
    ports:
      - "5108:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - CLOUD_INGESTION_URL=http://cloud-ingestion:3000/api/v1/edge/batch
      - CLOUD_INGESTION_URL_REQUIRED=true
      - CLOUD_AUTH_MODE=${CLOUD_AUTH_MODE:-api_key}
      - CLOUD_API_KEY=${CLOUD_API_KEY:-edge-local-key}
      - DD_SERVICE=edge-sync-forwarder
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-policy-sync:
    build:
      context: ./edge-policy-sync
      dockerfile: Dockerfile
    container_name: farmiq-edge-policy-sync
    ports:
      - "5109:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - BFF_BASE_URL=http://cloud-api-gateway-bff:3000
      - EDGE_CLOUD_TOKEN=${EDGE_CLOUD_TOKEN:-}
      - POLICY_SYNC_INTERVAL_SECONDS=60
      - POLICY_SYNC_BACKOFF_CAP_SECONDS=600
      - POLICY_SYNC_TIMEOUT_SECONDS=10
      - EDGE_CONTEXTS=${EDGE_CONTEXTS:-[]}
      - DD_SERVICE=edge-policy-sync
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-retention-janitor:
    build:
      context: ./edge-retention-janitor
      dockerfile: Dockerfile
    container_name: farmiq-edge-retention-janitor
    ports:
      - "5110:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - MEDIA_BASE_PATH=/data/media
      - MEDIA_RETENTION_DAYS=7
      - MIN_FREE_DISK_GB=5
      - JANITOR_INTERVAL_SECONDS=21600
      - JANITOR_DRY_RUN=true
      - DD_SERVICE=edge-retention-janitor
      - DD_ENV=development
    volumes:
      - ../../data/edge-media:/data/media
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-observability-agent:
    build:
      context: ./edge-observability-agent
      dockerfile: Dockerfile
    container_name: farmiq-edge-observability-agent
    ports:
      - "5111:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - OBS_POLL_INTERVAL_SECONDS=30
      - DISK_PATH=/data
      - EDGE_INGRESS_URL=http://edge-ingress-gateway:3000
      - EDGE_TELEMETRY_URL=http://edge-telemetry-timeseries:3000
      - EDGE_WEIGHVISION_URL=http://edge-weighvision-session:3000
      - EDGE_VISION_URL=http://edge-vision-inference:8000
      - EDGE_MEDIA_URL=http://edge-media-store:3000
      - EDGE_SYNC_URL=http://edge-sync-forwarder:3000
      - DD_SERVICE=edge-observability-agent
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-feed-intake:
    build:
      context: ./edge-feed-intake
      dockerfile: Dockerfile
    container_name: farmiq-edge-feed-intake
    ports:
      - "5112:5109"
    environment:
      - NODE_ENV=development
      - APP_PORT=5109
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MQTT_BROKER_URL=mqtt://edge-mqtt-broker:1883
      - EDGE_SYNC_FORWARDER_URL=http://edge-sync-forwarder:3000
      - DD_SERVICE=edge-feed-intake
      - DD_ENV=development
    networks:
      - farmiq-net
    depends_on:
      edge-mqtt-broker:
        condition: service_started
      edge-sync-forwarder:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5109/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  farmiq-net:
    driver: bridge

volumes:
  mqtt_data:
  mqtt_log:
