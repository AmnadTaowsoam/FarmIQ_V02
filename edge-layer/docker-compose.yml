version: '3.8'

services:
  # ============================================
  # EDGE SERVICES
  # ============================================
  edge-mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: farmiq-edge-mqtt
    ports:
      - "5100:1883"
    volumes:
      - ./edge-mqtt-broker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-t", "$$SYS/health", "-C", "1"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-ingress-gateway:
    build:
      context: ./edge-ingress-gateway
      dockerfile: Dockerfile
    container_name: farmiq-edge-ingress-gateway
    ports:
      - "5103:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MQTT_BROKER_URL=mqtt://edge-mqtt-broker:1883
      - EDGE_TELEMETRY_TIMESERIES_URL=http://edge-telemetry-timeseries:3000
      - EDGE_WEIGHVISION_SESSION_URL=http://edge-weighvision-session:3000
      - DOWNSTREAM_TIMEOUT_MS=5000
      - DEDUPE_TTL_MS=259200000
      - DEDUPE_CLEANUP_INTERVAL_MS=60000
      - DD_SERVICE=edge-ingress-gateway
      - DD_ENV=development
    depends_on:
      edge-mqtt-broker:
        condition: service_started
      edge-telemetry-timeseries:
        condition: service_started
      edge-weighvision-session:
        condition: service_started
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-telemetry-timeseries:
    build:
      context: ./edge-telemetry-timeseries
      dockerfile: Dockerfile
    container_name: farmiq-edge-telemetry-timeseries
    ports:
      - "5104:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_SERVICE=edge-telemetry-timeseries
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-weighvision-session:
    build:
      context: ./edge-weighvision-session
      dockerfile: Dockerfile
    container_name: farmiq-edge-weighvision-session
    ports:
      - "5105:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_SERVICE=edge-weighvision-session
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-media-store:
    build:
      context: ./edge-media-store
      dockerfile: Dockerfile
    container_name: farmiq-edge-media-store
    ports:
      - "5106:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MEDIA_STORAGE_PATH=/data/media
      - DD_SERVICE=edge-media-store
      - DD_ENV=development
    volumes:
      - ../../data/edge-media:/data/media
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-vision-inference:
    build:
      context: ./edge-vision-inference
      dockerfile: Dockerfile
    container_name: farmiq-edge-vision-inference
    ports:
      - "5107:8000"
    environment:
      - LOG_LEVEL=INFO
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - MEDIA_STORAGE_PATH=/data/media
      - DD_SERVICE=edge-vision-inference
      - DD_ENV=development
    volumes:
      - ../../data/edge-media:/data/media:ro
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  edge-sync-forwarder:
    build:
      context: ./edge-sync-forwarder
      dockerfile: Dockerfile
    container_name: farmiq-edge-sync-forwarder
    ports:
      - "5108:3000"
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - CLOUD_INGESTION_URL=http://cloud-ingestion:3000/api/v1/edge/batch
      - DD_SERVICE=edge-sync-forwarder
      - DD_ENV=development
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  farmiq-net:
    external: true

volumes:
  mqtt_data:
  mqtt_log:
