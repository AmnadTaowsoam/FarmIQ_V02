# BFF API Contracts

**Purpose**: Define all BFF endpoints required to power the FarmIQ Dashboard.  
**Scope**: Complete API contract definitions for `cloud-api-gateway-bff` endpoints consumed by `dashboard-web`.  
**Owner**: FarmIQ Backend Team  
**Last updated**: 2025-01-20  

---

## API Contract Template

Each endpoint includes:
- **Method + Path**: HTTP method and URL path
- **Query Params**: Required and optional query parameters
- **Headers**: Required headers (Authorization, x-request-id)
- **Request Body**: Request body structure (for POST/PATCH)
- **Response**: Response JSON structure
- **Errors**: Standard error responses
- **Status**: EXISTING (already implemented) or NEW (needs implementation)

---

## Authentication

All endpoints require:
- **Header**: `Authorization: Bearer <access_token>`
- **Header**: `x-request-id: <uuid-v4>` (generated by FE)

---

## Context / Registry Endpoints

### GET /api/v1/registry/tenants
**Status**: NEW  
**Purpose**: Get list of tenants accessible by current user.

**Query Params**:
- None

**Response**:
```json
{
  "data": [
    {
      "tenant_id": "uuid",
      "name": "Farm Company Ltd",
      "status": "active",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 1,
    "hasNext": false
  }
}
```

**Errors**:
- `401 Unauthorized`: Invalid or expired token
- `403 Forbidden`: User lacks permission

---

### GET /api/v1/registry/farms
**Status**: NEW  
**Purpose**: Get list of farms (filtered by tenant context).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page
- `q` (optional): Search query (farm name)
- `status` (optional): active, inactive, all

**Response**:
```json
{
  "data": [
    {
      "farm_id": "uuid",
      "tenant_id": "uuid",
      "name": "Farm A",
      "location": "Bangkok, Thailand",
      "barn_count": 5,
      "device_count": 20,
      "status": "active",
      "last_activity": "2025-12-20T10:00:00Z",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 10,
    "hasNext": false
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access to tenant

---

### GET /api/v1/registry/farms/:farmId
**Status**: NEW  
**Purpose**: Get farm details.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "farm_id": "uuid",
    "tenant_id": "uuid",
    "name": "Farm A",
    "location": "Bangkok, Thailand",
    "barn_count": 5,
    "device_count": 20,
    "status": "active",
    "created_at": "2025-01-01T00:00:00Z",
    "barns": [
      {
        "barn_id": "uuid",
        "name": "Barn 1",
        "device_count": 4
      }
    ]
  }
}
```

**Errors**:
- `404 Not Found`: Farm not found or user lacks access

---

### GET /api/v1/registry/barns
**Status**: NEW  
**Purpose**: Get list of barns (filtered by tenant/farm context).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page
- `q` (optional): Search query (barn name)
- `status` (optional): active, inactive, all

**Response**:
```json
{
  "data": [
    {
      "barn_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "name": "Barn 1",
      "type": "broiler",
      "device_count": 4,
      "current_temperature": 25.5,
      "current_humidity": 60.0,
      "status": "active",
      "last_activity": "2025-12-20T10:00:00Z",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 5,
    "hasNext": false
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### GET /api/v1/registry/barns/:barnId
**Status**: NEW  
**Purpose**: Get barn details.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "barn_id": "uuid",
    "tenant_id": "uuid",
    "farm_id": "uuid",
    "name": "Barn 1",
    "type": "broiler",
    "device_count": 4,
    "status": "active",
    "devices": [
      {
        "device_id": "uuid",
        "name": "Sensor Gateway 1",
        "type": "sensor-gateway",
        "status": "online",
        "last_seen": "2025-12-20T10:00:00Z"
      }
    ],
    "created_at": "2025-01-01T00:00:00Z"
  }
}
```

**Errors**:
- `404 Not Found`: Barn not found or user lacks access

---

### GET /api/v1/registry/devices
**Status**: NEW  
**Purpose**: Get list of devices (filtered by context).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `device_type` (optional): sensor-gateway, weighvision, all
- `status` (optional): online, offline, error, all
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page
- `q` (optional): Search query (device name/serial)

**Response**:
```json
{
  "data": [
    {
      "device_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "barn_id": "uuid",
      "name": "Sensor Gateway 1",
      "serial_number": "SG-001",
      "type": "sensor-gateway",
      "status": "online",
      "last_seen": "2025-12-20T10:00:00Z",
      "uptime_percent_24h": 99.5,
      "firmware_version": "1.2.3"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 20,
    "hasNext": false
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### GET /api/v1/registry/devices/:deviceId
**Status**: NEW  
**Purpose**: Get device details.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "device_id": "uuid",
    "tenant_id": "uuid",
    "farm_id": "uuid",
    "barn_id": "uuid",
    "name": "Sensor Gateway 1",
    "serial_number": "SG-001",
    "type": "sensor-gateway",
    "status": "online",
    "last_seen": "2025-12-20T10:00:00Z",
    "uptime_percent_24h": 99.5,
    "uptime_percent_7d": 98.0,
    "uptime_percent_30d": 97.5,
    "firmware_version": "1.2.3",
    "telemetry_count_today": 1440,
    "created_at": "2025-01-01T00:00:00Z"
  }
}
```

**Errors**:
- `404 Not Found`: Device not found or user lacks access

---

## Dashboard Overview Endpoints

### GET /api/v1/dashboard/overview
**Status**: EXISTING  
**Purpose**: Get overview KPIs and summary data.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID (if farm context)
- `barn_id` (optional): Barn ID (if barn context)
- `time_range` (optional, default: 7d): 24h, 7d, 30d

**Response**:
```json
{
  "data": {
    "kpis": {
      "total_farms": 10,
      "total_barns": 50,
      "active_devices": 45,
      "critical_alerts": 2,
      "avg_weight_today_kg": 2.5,
      "fcr_7day_avg": 1.8
    },
    "recent_alerts": [
      {
        "alert_id": "uuid",
        "severity": "critical",
        "type": "temperature",
        "message": "Temperature above threshold",
        "occurred_at": "2025-12-20T10:00:00Z"
      }
    ],
    "recent_activity": [
      {
        "type": "session_finalized",
        "barn_id": "uuid",
        "barn_name": "Barn 1",
        "occurred_at": "2025-12-20T10:00:00Z"
      }
    ],
    "weight_trend": [
      {
        "date": "2025-12-20",
        "avg_weight_kg": 2.5
      }
    ],
    "sensor_status": {
      "temperature": {
        "current": 25.5,
        "status": "normal"
      },
      "humidity": {
        "current": 60.0,
        "status": "normal"
      }
    }
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### GET /api/v1/dashboard/farms/:farmId
**Status**: EXISTING  
**Purpose**: Get farm dashboard with aggregated data (KPIs, trends, alerts).

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "farm_id": "uuid",
    "tenant_id": "uuid",
    "name": "Farm A",
    "location": "Bangkok, Thailand",
    "barn_count": 5,
    "device_count": 20,
    "status": "active",
    "kpis": {
      "avg_weight_today_kg": 2.5,
      "fcr_7day_avg": 1.8,
      "active_alerts": 2,
      "device_uptime_percent": 95.5
    },
    "weight_trend": [
      {
        "date": "2025-12-20",
        "avg_weight_kg": 2.5
      }
    ],
    "fcr_trend": [
      {
        "date": "2025-12-20",
        "fcr": 1.8
      }
    ],
    "device_status_summary": {
      "online": 18,
      "offline": 2,
      "error": 0
    },
    "alerts_summary": [
      {
        "alert_id": "uuid",
        "severity": "critical",
        "type": "temperature",
        "message": "Temperature above threshold",
        "occurred_at": "2025-12-20T10:00:00Z"
      }
    ]
  }
}
```

**Errors**:
- `404 Not Found`: Farm not found or user lacks access
- `403 Forbidden`: User lacks permission

---

### GET /api/v1/dashboard/barns/:barnId
**Status**: EXISTING  
**Purpose**: Get barn dashboard with operational data (sensor readings, device status, telemetry timeline).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID (for validation)

**Response**:
```json
{
  "data": {
    "barn_id": "uuid",
    "tenant_id": "uuid",
    "farm_id": "uuid",
    "name": "Barn 1",
    "type": "broiler",
    "device_count": 4,
    "current_temperature": 25.5,
    "current_humidity": 60.0,
    "status": "active",
    "device_status": [
      {
        "device_id": "uuid",
        "device_name": "Sensor Gateway 1",
        "status": "online",
        "last_seen": "2025-12-20T10:00:00Z",
        "uptime_percent_24h": 98.5
      }
    ],
    "telemetry_timeline": [
      {
        "timestamp": "2025-12-20T10:00:00Z",
        "temperature": 25.5,
        "humidity": 60.0
      }
    ]
  }
}
```

**Errors**:
- `404 Not Found`: Barn not found or user lacks access
- `403 Forbidden`: User lacks permission

---

## Telemetry Endpoints

### GET /api/v1/telemetry/readings
**Status**: NEW  
**Purpose**: Query telemetry readings with filtering and aggregation.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `device_id` (optional): Device ID
- `metric_type` (optional): temperature, humidity, weight, etc. (comma-separated for multiple)
- `start_time` (required): ISO 8601 timestamp
- `end_time` (required): ISO 8601 timestamp
- `aggregation` (optional): none, 1m, 5m, 15m, 1h, 1d
- `group_by` (optional): device, barn, farm
- `limit` (optional, default: 1000): Max data points

**Response**:
```json
{
  "data": {
    "readings": [
      {
        "timestamp": "2025-12-20T10:00:00Z",
        "tenant_id": "uuid",
        "farm_id": "uuid",
        "barn_id": "uuid",
        "device_id": "uuid",
        "metric_type": "temperature",
        "metric_value": 25.5,
        "unit": "celsius"
      }
    ],
    "statistics": {
      "count": 1000,
      "min": 20.0,
      "max": 30.0,
      "avg": 25.5,
      "stddev": 2.0
    },
    "coverage_percent": 95.5
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params or invalid time range
- `403 Forbidden`: User lacks access

---

### GET /api/v1/telemetry/latest
**Status**: NEW  
**Purpose**: Get latest telemetry readings for a barn (sensor matrix).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `barn_id` (required): Barn ID
- `device_type` (optional): sensor-gateway, weighvision, all

**Response**:
```json
{
  "data": {
    "sensors": [
      {
        "device_id": "uuid",
        "device_name": "Sensor Gateway 1",
        "metrics": [
          {
            "metric_type": "temperature",
            "value": 25.5,
            "unit": "celsius",
            "status": "normal",
            "timestamp": "2025-12-20T10:00:00Z"
          },
          {
            "metric_type": "humidity",
            "value": 60.0,
            "unit": "percent",
            "status": "normal",
            "timestamp": "2025-12-20T10:00:00Z"
          }
        ],
        "mini_trend": [25.0, 25.2, 25.4, 25.5]
      }
    ]
  }
}
```

**Errors**:
- `400 Bad Request`: Missing barn_id
- `403 Forbidden`: User lacks access

---

## WeighVision Endpoints

### GET /api/v1/weighvision/sessions
**Status**: NEW  
**Purpose**: Get list of WeighVision sessions.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `station_id` (optional): Station ID
- `batch_id` (optional): Batch ID
- `status` (optional): created, finalized, cancelled, all
- `start_date` (optional): ISO 8601 date
- `end_date` (optional): ISO 8601 date
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page

**Response**:
```json
{
  "data": [
    {
      "session_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "barn_id": "uuid",
      "station_id": "uuid",
      "batch_id": "uuid",
      "status": "finalized",
      "start_at": "2025-12-20T10:00:00Z",
      "end_at": "2025-12-20T10:05:00Z",
      "initial_weight_kg": 2.5,
      "final_weight_kg": 2.6,
      "image_count": 10,
      "created_at": "2025-12-20T10:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 100,
    "hasNext": true
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### GET /api/v1/weighvision/sessions/:sessionId
**Status**: NEW  
**Purpose**: Get WeighVision session details.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `include_images` (optional, default: false): Include image metadata (requires permission)

**Response**:
```json
{
  "data": {
    "session_id": "uuid",
    "tenant_id": "uuid",
    "farm_id": "uuid",
    "barn_id": "uuid",
    "station_id": "uuid",
    "batch_id": "uuid",
    "status": "finalized",
    "start_at": "2025-12-20T10:00:00Z",
    "end_at": "2025-12-20T10:05:00Z",
    "initial_weight_kg": 2.5,
    "final_weight_kg": 2.6,
    "image_count": 10,
    "predictions": [
      {
        "image_id": "uuid",
        "timestamp": "2025-12-20T10:01:00Z",
        "predicted_weight_kg": 2.55,
        "confidence_score": 0.95,
        "size_proxy": "medium",
        "is_outlier": false
      }
    ],
    "statistics": {
      "min_weight_kg": 2.4,
      "max_weight_kg": 2.7,
      "avg_weight_kg": 2.55,
      "stddev_kg": 0.1,
      "outlier_count": 1
    },
    "images": [
      {
        "image_id": "uuid",
        "presigned_url": "https://...",
        "expires_at": "2025-12-20T10:30:00Z",
        "timestamp": "2025-12-20T10:01:00Z"
      }
    ]
  }
}
```

**Errors**:
- `404 Not Found`: Session not found or user lacks access
- `403 Forbidden`: User lacks permission to view images

---

### GET /api/v1/weighvision/analytics
**Status**: NEW  
**Purpose**: Get weight analytics (trends, distributions, statistics).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `batch_id` (optional): Batch ID
- `start_date` (required): ISO 8601 date
- `end_date` (required): ISO 8601 date
- `aggregation` (optional, default: daily): daily, weekly, monthly

**Response**:
```json
{
  "data": {
    "weight_trend": [
      {
        "date": "2025-12-20",
        "avg_weight_kg": 2.5,
        "min_weight_kg": 2.0,
        "max_weight_kg": 3.0,
        "p10_weight_kg": 2.2,
        "p25_weight_kg": 2.3,
        "p50_weight_kg": 2.5,
        "p75_weight_kg": 2.7,
        "p90_weight_kg": 2.9
      }
    ],
    "statistics": {
      "current_avg_weight_kg": 2.5,
      "current_stddev_kg": 0.2,
      "uniformity_percent": 85.0,
      "cv": 0.08,
      "iqr_kg": 0.4
    },
    "distribution": {
      "bins": [
        {"range": "2.0-2.2", "count": 10},
        {"range": "2.2-2.4", "count": 25},
        {"range": "2.4-2.6", "count": 50},
        {"range": "2.6-2.8", "count": 25},
        {"range": "2.8-3.0", "count": 10}
      ]
    }
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params or invalid date range
- `403 Forbidden`: User lacks access

---

## Feeding & FCR Endpoints

### GET /api/v1/feeding/daily
**Status**: ⚠️ **DEPRECATED** (use `GET /api/v1/feed/intake-records` via `cloud-feed-service` or `GET /api/v1/kpi/feeding` for KPI queries - see `docs/contracts/feed-service.contract.md`)  
**Purpose**: Get daily feed intake data.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `batch_id` (optional): Batch ID
- `start_date` (required): ISO 8601 date
- `end_date` (required): ISO 8601 date

**Response**:
```json
{
  "data": {
    "daily_feed": [
      {
        "date": "2025-12-20",
        "feed_intake_kg": 100.5,
        "planned_feed_kg": 100.0,
        "difference_kg": 0.5,
        "cumulative_feed_kg": 1500.0
      }
    ],
    "statistics": {
      "total_feed_kg": 1500.0,
      "avg_daily_feed_kg": 100.0,
      "min_daily_feed_kg": 95.0,
      "max_daily_feed_kg": 105.0
    }
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params
- `403 Forbidden`: User lacks access

---

### GET /api/v1/feeding/fcr
**Status**: ⚠️ **DEPRECATED** (canonical endpoint: `GET /api/v1/kpi/feeding` - see `docs/contracts/feed-service.contract.md`)  
**Purpose**: Get FCR (Feed Conversion Ratio) and forecast data.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `batch_id` (optional): Batch ID
- `start_date` (required): ISO 8601 date
- `end_date` (required): ISO 8601 date
- `target_weight_kg` (optional): Target market weight for forecast

**Response**:
```json
{
  "data": {
    "fcr_trend": [
      {
        "date": "2025-12-20",
        "fcr": 1.8,
        "adg_kg_per_day": 0.05,
        "feed_intake_kg": 100.0,
        "weight_gain_kg": 55.5
      }
    ],
    "current_metrics": {
      "fcr_7day_avg": 1.8,
      "adg_kg_per_day": 0.05,
      "current_weight_kg": 2.5
    },
    "forecast": {
      "target_weight_kg": 3.0,
      "predicted_days_to_target": 10,
      "predicted_fcr_at_target": 1.85,
      "confidence_score": 0.9,
      "confidence_bands": {
        "lower": 8,
        "upper": 12
      }
    }
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params or insufficient data for forecast
- `403 Forbidden`: User lacks access

---

## Analytics / AI Endpoints

### GET /api/v1/analytics/anomalies
**Status**: NEW  
**Purpose**: Get detected anomalies and early warnings.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `device_id` (optional): Device ID
- `severity` (optional): critical, warning, info, all
- `status` (optional): active, acknowledged, resolved, all
- `type` (optional): temperature, humidity, weight, feed, all
- `start_time` (optional): ISO 8601 timestamp
- `end_time` (optional): ISO 8601 timestamp
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page

**Response**:
```json
{
  "data": [
    {
      "anomaly_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "barn_id": "uuid",
      "device_id": "uuid",
      "type": "temperature",
      "severity": "critical",
      "status": "active",
      "message": "Temperature above threshold (30°C > 28°C)",
      "occurred_at": "2025-12-20T10:00:00Z",
      "acknowledged_at": null,
      "acknowledged_by": null,
      "resolved_at": null
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 50,
    "hasNext": true
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### POST /api/v1/analytics/anomalies/:anomalyId/acknowledge
**Status**: NEW  
**Purpose**: Acknowledge an anomaly.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Request Body**:
```json
{
  "notes": "Investigating issue"
}
```

**Response**:
```json
{
  "data": {
    "anomaly_id": "uuid",
    "status": "acknowledged",
    "acknowledged_at": "2025-12-20T10:05:00Z",
    "acknowledged_by": "user@example.com"
  }
}
```

**Errors**:
- `404 Not Found`: Anomaly not found
- `403 Forbidden`: User lacks permission to acknowledge

---

### GET /api/v1/analytics/recommendations
**Status**: NEW  
**Purpose**: Get AI-driven recommendations.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `priority` (optional): high, medium, low, all
- `status` (optional): active, acknowledged, implemented, dismissed, all
- `category` (optional): environment, feeding, health, performance, all
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page

**Response**:
```json
{
  "data": [
    {
      "recommendation_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "barn_id": "uuid",
      "title": "Adjust temperature setpoint",
      "category": "environment",
      "priority": "high",
      "status": "active",
      "description": "Current temperature is above optimal range",
      "reasoning": "Temperature readings show 30°C average, optimal range is 25-28°C",
      "expected_impact": "Reduce FCR by 0.1, improve weight gain by 5%",
      "created_at": "2025-12-20T10:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 10,
    "hasNext": false
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### POST /api/v1/analytics/scenario
**Status**: NEW  
**Purpose**: Run what-if scenario analysis.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Request Body**:
```json
{
  "context": {
    "farm_id": "uuid",
    "barn_id": "uuid",
    "batch_id": "uuid"
  },
  "scenario_type": "feed_adjustment",
  "parameters": {
    "feed_formula_change_percent": 5.0,
    "temperature_adjustment_celsius": -2.0
  },
  "target_weight_kg": 3.0
}
```

**Response**:
```json
{
  "data": {
    "scenario_id": "uuid",
    "baseline": {
      "current_weight_kg": 2.5,
      "fcr": 1.8,
      "adg_kg_per_day": 0.05,
      "predicted_days_to_target": 10
    },
    "scenario": {
      "predicted_weight_kg": 2.6,
      "predicted_fcr": 1.75,
      "predicted_adg_kg_per_day": 0.055,
      "predicted_days_to_target": 8
    },
    "impact": {
      "weight_change_kg": 0.1,
      "fcr_change": -0.05,
      "adg_change_kg_per_day": 0.005,
      "days_saved": 2
    },
    "confidence_score": 0.85,
    "computed_at": "2025-12-20T10:05:00Z"
  }
}
```

**Errors**:
- `400 Bad Request`: Invalid scenario parameters
- `403 Forbidden`: User lacks access
- `429 Too Many Requests`: Too many scenario requests (rate limited)

---

## Alerts Endpoints

### GET /api/v1/alerts
**Status**: EXISTING  
**Purpose**: Get alerts and notifications.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `device_id` (optional): Device ID
- `severity` (optional): critical, warning, info, all
- `status` (optional): active, acknowledged, resolved, all
- `type` (optional): temperature, humidity, weight, feed, device, system, all
- `start_time` (optional): ISO 8601 timestamp
- `end_time` (optional): ISO 8601 timestamp
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page

**Response**:
```json
{
  "data": [
    {
      "alert_id": "uuid",
      "tenant_id": "uuid",
      "farm_id": "uuid",
      "barn_id": "uuid",
      "device_id": "uuid",
      "severity": "critical",
      "type": "temperature",
      "status": "active",
      "message": "Temperature above threshold",
      "occurred_at": "2025-12-20T10:00:00Z",
      "acknowledged_at": null,
      "acknowledged_by": null,
      "resolved_at": null
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 50,
    "hasNext": true
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks access

---

### POST /api/v1/alerts/:alertId/acknowledge
**Status**: NEW  
**Purpose**: Acknowledge an alert.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Request Body**:
```json
{
  "notes": "Investigating issue"
}
```

**Response**:
```json
{
  "data": {
    "alert_id": "uuid",
    "status": "acknowledged",
    "acknowledged_at": "2025-12-20T10:05:00Z",
    "acknowledged_by": "user@example.com"
  }
}
```

**Errors**:
- `404 Not Found`: Alert not found
- `403 Forbidden`: User lacks permission to acknowledge

---

## Ops Endpoints

### GET /api/v1/ops/data-quality
**Status**: NEW  
**Purpose**: Get data quality and coverage metrics.

**Query Params**:
- `tenant_id` (required): Tenant ID
- `farm_id` (optional): Farm ID
- `barn_id` (optional): Barn ID
- `device_id` (optional): Device ID
- `start_time` (required): ISO 8601 timestamp
- `end_time` (required): ISO 8601 timestamp
- `metric_type` (optional): temperature, humidity, weight, feed, all

**Response**:
```json
{
  "data": {
    "coverage_percent": 95.5,
    "missing_data_periods": [
      {
        "start": "2025-12-20T02:00:00Z",
        "end": "2025-12-20T02:15:00Z",
        "duration_minutes": 15
      }
    ],
    "device_uptime": [
      {
        "device_id": "uuid",
        "device_name": "Sensor Gateway 1",
        "uptime_percent_24h": 99.5,
        "uptime_percent_7d": 98.0,
        "uptime_percent_30d": 97.5,
        "last_seen": "2025-12-20T10:00:00Z"
      }
    ],
    "data_freshness": {
      "avg_lag_seconds": 45,
      "p95_lag_seconds": 90,
      "p99_lag_seconds": 120
    }
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params
- `403 Forbidden`: User lacks access (ops pages are admin-only)

---

### GET /api/v1/ops/sync-status
**Status**: NEW  
**Purpose**: Get sync status and backlog (ops-facing).

**Query Params**:
- `tenant_id` (optional): Tenant ID (platform_admin can omit for all tenants)
- `edge_cluster_id` (optional): Edge cluster ID

**Response**:
```json
{
  "data": {
    "sync_backlog": {
      "total_pending": 150,
      "oldest_pending_age_seconds": 300,
      "backlog_trend": [
        {
          "timestamp": "2025-12-20T10:00:00Z",
          "pending_count": 150
        }
      ]
    },
    "edge_clusters": [
      {
        "cluster_id": "uuid",
        "tenant_id": "uuid",
        "status": "online",
        "last_sync": "2025-12-20T10:00:00Z",
        "sync_success_rate_24h": 99.5,
        "pending_events": 50
      }
    ],
    "ingestion_errors_24h": 5,
    "api_latency_p95_ms": 250
  }
}
```

**Errors**:
- `403 Forbidden`: User lacks access (platform_admin or tenant_admin only)

---

## Reports & Export Endpoints

### POST /api/v1/reports/generate
**Status**: NEW  
**Purpose**: Generate a KPI report.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Request Body**:
```json
{
  "report_type": "kpi_summary",
  "context": {
    "farm_id": "uuid",
    "barn_id": "uuid"
  },
  "time_range": {
    "start": "2025-12-13T00:00:00Z",
    "end": "2025-12-20T00:00:00Z"
  },
  "format": "pdf"
}
```

**Response**:
```json
{
  "data": {
    "report_id": "uuid",
    "status": "generating",
    "estimated_completion_seconds": 30,
    "download_url": null
  }
}
```

**Errors**:
- `400 Bad Request`: Invalid report parameters
- `403 Forbidden`: User lacks access
- `429 Too Many Requests`: Too many report requests

---

### GET /api/v1/reports/:reportId
**Status**: NEW  
**Purpose**: Get report status and download URL.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "report_id": "uuid",
    "status": "completed",
    "download_url": "https://...",
    "expires_at": "2025-12-21T10:00:00Z",
    "created_at": "2025-12-20T10:00:00Z"
  }
}
```

**Errors**:
- `404 Not Found`: Report not found
- `403 Forbidden`: User lacks access

---

### POST /api/v1/export/create
**Status**: NEW  
**Purpose**: Create a data export.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Request Body**:
```json
{
  "data_type": "telemetry",
  "context": {
    "farm_id": "uuid",
    "barn_id": "uuid"
  },
  "time_range": {
    "start": "2025-12-13T00:00:00Z",
    "end": "2025-12-20T00:00:00Z"
  },
  "filters": {
    "metric_types": ["temperature", "humidity"]
  },
  "format": "csv",
  "columns": ["timestamp", "device_id", "metric_type", "metric_value"]
}
```

**Response**:
```json
{
  "data": {
    "export_id": "uuid",
    "status": "preparing",
    "estimated_completion_seconds": 60,
    "download_url": null
  }
}
```

**Errors**:
- `400 Bad Request`: Invalid export parameters
- `403 Forbidden`: User lacks access
- `429 Too Many Requests`: Too many export requests

---

### GET /api/v1/export/:exportId
**Status**: NEW  
**Purpose**: Get export status and download URL.

**Query Params**:
- `tenant_id` (required): Tenant ID

**Response**:
```json
{
  "data": {
    "export_id": "uuid",
    "status": "completed",
    "download_url": "https://...",
    "expires_at": "2025-12-21T10:00:00Z",
    "created_at": "2025-12-20T10:00:00Z",
    "file_size_bytes": 1048576
  }
}
```

**Errors**:
- `404 Not Found`: Export not found
- `403 Forbidden`: User lacks access

---

## Admin Endpoints

### GET /api/v1/admin/users
**Status**: NEW  
**Purpose**: Get list of users (admin-only).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `role` (optional): platform_admin, tenant_admin, farm_manager, operator, viewer, all
- `status` (optional): active, inactive, all
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page
- `q` (optional): Search query (name/email)

**Response**:
```json
{
  "data": [
    {
      "user_id": "uuid",
      "email": "user@example.com",
      "name": "John Doe",
      "roles": ["farm_manager"],
      "status": "active",
      "last_login": "2025-12-20T09:00:00Z",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 50,
    "hasNext": true
  }
}
```

**Errors**:
- `400 Bad Request`: Missing tenant_id
- `403 Forbidden`: User lacks admin access

---

### GET /api/v1/admin/audit
**Status**: NEW  
**Purpose**: Get audit log (admin-only).

**Query Params**:
- `tenant_id` (required): Tenant ID
- `event_type` (optional): create, update, delete, login, logout, permission_change, all
- `user_id` (optional): User ID who performed action
- `resource_type` (optional): tenant, farm, barn, device, user, role, all
- `start_time` (required): ISO 8601 timestamp
- `end_time` (required): ISO 8601 timestamp
- `page` (optional, default: 1): Page number
- `limit` (optional, default: 25): Items per page
- `q` (optional): Search query

**Response**:
```json
{
  "data": [
    {
      "audit_id": "uuid",
      "timestamp": "2025-12-20T10:00:00Z",
      "user_id": "uuid",
      "user_email": "admin@example.com",
      "event_type": "update",
      "resource_type": "farm",
      "resource_id": "uuid",
      "resource_name": "Farm A",
      "action_details": {
        "field": "status",
        "old_value": "inactive",
        "new_value": "active"
      },
      "ip_address": "192.168.1.1"
    }
  ],
  "meta": {
    "page": 1,
    "limit": 25,
    "total": 1000,
    "hasNext": true
  }
}
```

**Errors**:
- `400 Bad Request`: Missing required params
- `403 Forbidden`: User lacks admin access

---

## Error Response Format

All errors follow this standard format:

```json
{
  "error": {
    "code": "ERR_RESOURCE_NOT_FOUND",
    "message": "The requested resource does not exist.",
    "traceId": "abc-123-xyz",
    "details": {
      "resource_type": "barn",
      "resource_id": "uuid"
    }
  }
}
```

**Common Error Codes**:
- `ERR_VALIDATION_FAILED`: Invalid request parameters
- `ERR_RESOURCE_NOT_FOUND`: Resource not found or user lacks access
- `ERR_UNAUTHORIZED`: Invalid or expired token
- `ERR_FORBIDDEN`: User lacks permission
- `ERR_RATE_LIMIT_EXCEEDED`: Too many requests
- `ERR_INTERNAL_ERROR`: Server error

---

## Related Documentation

- [API Standards](shared/01-api-standards.md): Base path, headers, error format
- [API Catalog](shared/00-api-catalog.md): Service-level API documentation
- [Page Specifications](02-page-specs.md): Pages that consume these endpoints

