services:
  postgres:
    image: postgres:16-alpine
    container_name: farmiq-cloud-postgres
    ports:
      - "5140:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-farmiq}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-farmiq_dev}
      - POSTGRES_DB=${POSTGRES_DB:-farmiq}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-farmiq}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  prisma-studio-identity-access:
    build:
      context: ./cloud-identity-access
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5551:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_identity_access
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-identity-access/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-tenant-registry:
    build:
      context: ./cloud-tenant-registry
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5552:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_tenant_registry
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-tenant-registry/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-standards:
    build:
      context: ./cloud-standards-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5553:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_standards_service
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-standards-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-ingestion:
    build:
      context: ./cloud-ingestion
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5554:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_ingestion
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-ingestion/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-telemetry:
    build:
      context: ./cloud-telemetry-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5555:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_telemetry
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-telemetry-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-api-gateway-bff:
    build:
      context: ./cloud-api-gateway-bff
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5556:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_api_gateway_bff
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-api-gateway-bff/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-config-rules:
    build:
      context: ./cloud-config-rules-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5557:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_config_rules
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-config-rules-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-audit-log:
    build:
      context: ./cloud-audit-log-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5558:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_audit_log
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-audit-log-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-notification:
    build:
      context: ./cloud-notification-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5559:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_notification
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-notification-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-reporting-export:
    build:
      context: ./cloud-reporting-export-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5560:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_reporting_export
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-reporting-export-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-feed:
    build:
      context: ./cloud-feed-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5561:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_feed
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-feed-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-barn-records:
    build:
      context: ./cloud-barn-records-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5562:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_barn_records
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-barn-records-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-weighvision-readmodel:
    build:
      context: ./cloud-weighvision-readmodel
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5563:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_weighvision_readmodel
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-weighvision-readmodel/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-analytics:
    image: node:20-alpine
    working_dir: /usr/src/app
    ports:
      - "5564:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_analytics
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-analytics-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-billing:
    build:
      context: ./cloud-billing-service
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5565:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_billing
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-billing-service/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  prisma-studio-fleet-management:
    build:
      context: ./cloud-fleet-management
      dockerfile: Dockerfile
      target: production
    working_dir: /usr/src/app
    ports:
      - "5566:5555"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_fleet_management
    dns:
      - 8.8.8.8
      - 8.8.4.4
    command: [ "sh", "-c", "npm_config_loglevel=error npm_config_fund=false npm_config_audit=false npx prisma@5.22.0 studio --schema prisma/schema.prisma --hostname 0.0.0.0 --port 5555" ]
    volumes:
      - ./cloud-fleet-management/prisma:/usr/src/app/prisma:ro
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

networks:
  farmiq-net:
    name: farmiq-net
    driver: bridge

volumes:
  postgres_data:

