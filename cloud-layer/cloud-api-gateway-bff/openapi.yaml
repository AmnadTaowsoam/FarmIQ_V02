openapi: 3.0.0
info:
  title: FarmIQ Cloud API Gateway BFF
  version: 1.0.0
  description: >
    Backend-for-Frontend for the FarmIQ dashboard. Aggregates data from cloud services
    (identity, tenant registry, telemetry, analytics) and exposes dashboard-friendly
    APIs. Does not access databases directly.

paths:
  /api/health:
    get:
      summary: Health check
      tags: [System]
      responses:
        '200':
          description: OK

  /api/ready:
    get:
      summary: Readiness check
      tags: [System]
      responses:
        '200':
          description: Service is ready

  /api/v1/dashboard/overview:
    get:
      summary: Get tenant-level dashboard overview
      tags: [Dashboard]
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: tenantId
          schema:
            type: string
          required: false
          description: >
            Tenant scope. Optional if JWT contains tenant_id claim. Required
            when caller is platform_admin querying another tenant.
      responses:
        '200':
          description: Overview data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverviewResponse'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '502':
          description: Downstream error

  /api/v1/dashboard/farms/{farmId}:
    get:
      summary: Get dashboard data for a specific farm
      tags: [Dashboard]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: farmId
          required: true
          schema:
            type: string
        - in: query
          name: tenantId
          schema:
            type: string
          required: false
      responses:
        '200':
          description: Farm dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FarmDashboardResponse'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '502':
          description: Downstream error

  /api/v1/dashboard/barns/{barnId}:
    get:
      summary: Get dashboard data for a specific barn
      tags: [Dashboard]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: barnId
          required: true
          schema:
            type: string
        - in: query
          name: tenantId
          schema:
            type: string
          required: false
      responses:
        '200':
          description: Barn dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BarnDashboardResponse'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '502':
          description: Downstream error

  /api/v1/dashboard/alerts:
    get:
      summary: Get alerts for current tenant
      tags: [Dashboard]
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: tenantId
          schema:
            type: string
          required: false
      responses:
        '200':
          description: Alerts data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '502':
          description: Downstream error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    OverviewResponse:
      type: object
      properties:
        topology:
          description: Topology summary from tenant registry
          nullable: true
        telemetry:
          type: object
          properties:
            metrics:
              type: object
            aggregates:
              type: array
              items:
                type: object
        alerts:
          type: array
          items:
            type: object
        analyticsAvailable:
          type: boolean

    FarmDashboardResponse:
      type: object
      properties:
        farm:
          type: object
          nullable: true
        barns:
          type: array
          items:
            type: object
        telemetryAggregates:
          type: array
          items:
            type: object

    BarnDashboardResponse:
      type: object
      properties:
        barn:
          type: object
          nullable: true
        telemetryAggregates:
          type: array
          items:
            type: object
        telemetryReadings:
          type: array
          items:
            type: object

    AlertsResponse:
      type: object
      properties:
        alerts:
          type: array
          items:
            type: object
        analyticsAvailable:
          type: boolean