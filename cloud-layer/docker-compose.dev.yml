# Development overrides for cloud services
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# Or: docker compose -f docker-compose.yml -f docker-compose.dev.yml build
# Or standalone: docker compose -f docker-compose.dev.yml up

services:
  # ============================================
  # CLOUD INFRASTRUCTURE
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: farmiq-cloud-postgres
    ports:
      - "5140:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-farmiq}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-farmiq_dev}
      - POSTGRES_DB=${POSTGRES_DB:-farmiq}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-farmiq}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: farmiq-cloud-rabbitmq
    ports:
      - "5150:5672"
      - "5151:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-farmiq}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-farmiq_dev}
      - RABBITMQ_DEFAULT_VHOST=/
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./cloud-rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./cloud-rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
      - ./cloud-rabbitmq/init.sh:/docker-entrypoint-init.d/init.sh:ro
    networks:
      - farmiq-net
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Datadog Agent - Commented out until DD_API_KEY is configured
  # datadog:
  #   image: gcr.io/datadoghq/agent:7
  #   container_name: farmiq-cloud-datadog-agent
  #   restart: unless-stopped
  #   ports:
  #     - "8126:8126"   # APM intake
  #     - "8125:8125/udp" # dogstatsd
  #   environment:
  #     - DD_API_KEY=${DD_API_KEY}
  #     - DD_SITE=${DD_SITE:-datadoghq.com}
  #     - DD_ENV=${DD_ENV:-dev}
  #     - DD_TAGS=project:farmiq layer:cloud stack:dev
  #     - DD_LOGS_ENABLED=true
  #     - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
  #     - DD_APM_ENABLED=true
  #     - DD_APM_NON_LOCAL_TRAFFIC=true
  #     - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - /proc/:/host/proc/:ro
  #     - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #   networks:
  #     - farmiq-net

  # ============================================
  # CLOUD SERVICES
  # ============================================
  cloud-identity-access:
    build:
      context: ./cloud-identity-access
      dockerfile: Dockerfile
      target: development
    ports:
      - "5120:3000"
    volumes:
      - ./cloud-identity-access/src:/usr/src/app/src:ro
      - ./cloud-identity-access/package.json:/usr/src/app/package.json:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-identity-access
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-tenant-registry:
    build:
      context: ./cloud-tenant-registry
      dockerfile: Dockerfile
      target: development
    ports:
      - "5121:3000"
    volumes:
      - ./cloud-tenant-registry/src:/usr/src/app/src:ro
      - ./cloud-tenant-registry/package.json:/usr/src/app/package.json:ro
      - ./cloud-tenant-registry/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-tenant-registry
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-ingestion:
    build:
      context: ./cloud-ingestion
      dockerfile: Dockerfile
      target: development
    ports:
      - "5122:3000"
    volumes:
      - ./cloud-ingestion/src:/usr/src/app/src:ro
      - ./cloud-ingestion/package.json:/usr/src/app/package.json:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-ingestion
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-telemetry-service:
    build:
      context: ./cloud-telemetry-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5123:3000"
    volumes:
      - ./cloud-telemetry-service/src:/usr/src/app/src:ro
      - ./cloud-telemetry-service/package.json:/usr/src/app/package.json:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-telemetry-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-analytics-service:
    build:
      context: ./cloud-analytics-service
      dockerfile: Dockerfile
    ports:
      - "5124:8000"
    volumes:
      - ./cloud-analytics-service/app:/app/app:ro
    command: ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    environment:
      - LOG_LEVEL=DEBUG
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-analytics-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cloud-api-gateway-bff:
    build:
      context: ./cloud-api-gateway-bff
      dockerfile: Dockerfile
      target: development
    ports:
      - "5125:3000"
    volumes:
      - ./cloud-api-gateway-bff/src:/usr/src/app/src:ro
      - ./cloud-api-gateway-bff/package.json:/usr/src/app/package.json:ro
      - ./cloud-api-gateway-bff/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - IDENTITY_BASE_URL=http://cloud-identity-access:3000
      - REGISTRY_BASE_URL=http://cloud-tenant-registry:3000
      - TELEMETRY_BASE_URL=http://cloud-telemetry-service:3000
      - ANALYTICS_BASE_URL=http://cloud-analytics-service:8000
      - WEIGHVISION_READMODEL_BASE_URL=http://cloud-weighvision-readmodel:3000
      - CONFIG_RULES_BASE_URL=http://cloud-config-rules-service:3000
      - AUDIT_LOG_BASE_URL=http://cloud-audit-log-service:3000
      - NOTIFICATION_BASE_URL=http://cloud-notification-service:3000
      - REPORTING_EXPORT_BASE_URL=http://cloud-reporting-export-service:3000
      - FEED_SERVICE_URL=http://cloud-feed-service:3000
      - BARN_RECORDS_SERVICE_URL=http://cloud-barn-records-service:3000
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-api-gateway-bff
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-config-rules-service:
    build:
      context: ./cloud-config-rules-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5126:3000"
    volumes:
      - ./cloud-config-rules-service/src:/usr/src/app/src:ro
      - ./cloud-config-rules-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-config-rules-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-config-rules-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-audit-log-service:
    build:
      context: ./cloud-audit-log-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5127:3000"
    volumes:
      - ./cloud-audit-log-service/src:/usr/src/app/src:ro
      - ./cloud-audit-log-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-audit-log-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-audit-log-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  cloud-notification-service:
    build:
      context: ./cloud-notification-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5128:3000"
    volumes:
      - ./cloud-notification-service/src:/usr/src/app/src:ro
      - ./cloud-notification-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-notification-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - WORKER_CONCURRENCY=1
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-notification-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cloud-reporting-export-service:
    build:
      context: ./cloud-reporting-export-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5129:3000"
    volumes:
      - ./cloud-reporting-export-service/src:/usr/src/app/src:ro
      - ./cloud-reporting-export-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-reporting-export-service/prisma:/usr/src/app/prisma:ro
      - report_exports_data:/data/exports
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - REPORT_DOWNLOAD_SECRET=${REPORT_DOWNLOAD_SECRET:-dev-report-secret}
      - EXPORT_ROOT=/data/exports
      - WORKER_CONCURRENCY=1
      - CLOUD_FEED_SERVICE_URL=http://cloud-feed-service:5130
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-reporting-export-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cloud-feed-service:
    build:
      context: ./cloud-feed-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5130:3000"
    volumes:
      - ./cloud-feed-service/src:/usr/src/app/src:ro
      - ./cloud-feed-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-feed-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-feed-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cloud-barn-records-service:
    build:
      context: ./cloud-barn-records-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5131:3000"
    volumes:
      - ./cloud-barn-records-service/src:/usr/src/app/src:ro
      - ./cloud-barn-records-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-barn-records-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-barn-records-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  cloud-weighvision-readmodel:
    build:
      context: ./cloud-weighvision-readmodel
      dockerfile: Dockerfile
      target: development
    ports:
      - "5132:3000"
    volumes:
      - ./cloud-weighvision-readmodel/src:/usr/src/app/src:ro
      - ./cloud-weighvision-readmodel/package.json:/usr/src/app/package.json:ro
      - ./cloud-weighvision-readmodel/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/${POSTGRES_DB:-farmiq}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-weighvision-readmodel
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

networks:
  farmiq-net:
    external: true

volumes:
  postgres_data:
  rabbitmq_data:
  report_exports_data:
