# Development overrides for cloud services
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# Or: docker compose -f docker-compose.yml -f docker-compose.dev.yml build
# Or standalone: docker compose -f docker-compose.dev.yml up

services:
  # ============================================
  # CLOUD INFRASTRUCTURE
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: farmiq-cloud-postgres
    ports:
      - "5140:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-farmiq}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-farmiq_dev}
      - POSTGRES_DB=${POSTGRES_DB:-farmiq}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-farmiq}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: farmiq-cloud-pgadmin
    ports:
      - "5160:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@farmiq.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin123}
      - PGADMIN_CONFIG_SESSION_COOKIE_NAME='cloud_pgadmin_session'
      - PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION=False
      - PGADMIN_CONFIG_CONSOLE_LOG_LEVEL=10
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy

  vault:
    image: hashicorp/vault:1.13.3
    container_name: farmiq-cloud-vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/file
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD", "vault", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: farmiq-cloud-rabbitmq
    ports:
      - "5150:5672"
      - "5151:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-farmiq}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS:-farmiq_dev}
      - RABBITMQ_DEFAULT_VHOST=/
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./cloud-rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./cloud-rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
      - ./cloud-rabbitmq/init.sh:/docker-entrypoint-init.d/init.sh:ro
    networks:
      - farmiq-net
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 90s
    deploy:
      resources:
        limits:
          cpus: '0.30'
          memory: 256M

  # Datadog Agent - Commented out until DD_API_KEY is configured
  # datadog:
  #   image: gcr.io/datadoghq/agent:7
  #   container_name: farmiq-cloud-datadog-agent
  #   restart: unless-stopped
  #   ports:
  #     - "8126:8126"   # APM intake
  #     - "8125:8125/udp" # dogstatsd
  #   environment:
  #     - DD_API_KEY=${DD_API_KEY}
  #     - DD_SITE=${DD_SITE:-datadoghq.com}
  #     - DD_ENV=${DD_ENV:-dev}
  #     - DD_TAGS=project:farmiq layer:cloud stack:dev
  #     - DD_LOGS_ENABLED=true
  #     - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
  #     - DD_APM_ENABLED=true
  #     - DD_APM_NON_LOCAL_TRAFFIC=true
  #     - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - /proc/:/host/proc/:ro
  #     - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #   networks:
  #     - farmiq-net

  # ============================================
  # CLOUD SERVICES
  # ============================================
  cloud-identity-access:
    build:
      context: ./cloud-identity-access
      dockerfile: Dockerfile
      target: development
    ports:
      - "5120:3000"
    volumes:
      - ./cloud-identity-access/src:/usr/src/app/src:ro
      - ./cloud-identity-access/package.json:/usr/src/app/package.json:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_identity_access
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-change-in-production}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET:-dev-refresh-secret-change-in-production}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-identity-access
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-tenant-registry:
    build:
      context: ./cloud-tenant-registry
      dockerfile: Dockerfile
      target: development
    ports:
      - "5121:3000"
    volumes:
      - ./cloud-tenant-registry/src:/usr/src/app/src:ro
      - ./cloud-tenant-registry/package.json:/usr/src/app/package.json:ro
      - ./cloud-tenant-registry/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_tenant_registry
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-tenant-registry
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-standards-service:
    build:
      context: ./cloud-standards-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5133:3000"
    volumes:
      - ./cloud-standards-service/src:/usr/src/app/src:ro
      - ./cloud-standards-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-standards-service/prisma:/usr/src/app/prisma:ro
      - ./cloud-standards-service/openapi.yaml:/usr/src/app/openapi.yaml:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_standards_service
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-standards-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-ingestion:
    build:
      context: ./cloud-ingestion
      dockerfile: Dockerfile
      target: development
    ports:
      - "5122:3000"
      - "5300:3000"
    volumes:
      - ./cloud-ingestion/src:/usr/src/app/src:ro
      - ./cloud-ingestion/package.json:/usr/src/app/package.json:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_ingestion
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - CLOUD_AUTH_MODE=${CLOUD_AUTH_MODE:-none}
      - CLOUD_API_KEYS=${CLOUD_API_KEYS:-}
      - CLOUD_HMAC_SECRETS=${CLOUD_HMAC_SECRETS:-}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-ingestion
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-telemetry-service:
    build:
      context: ./cloud-telemetry-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5123:3000"
    volumes:
      - ./cloud-telemetry-service/src:/usr/src/app/src:ro
      - ./cloud-telemetry-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-telemetry-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_telemetry
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-telemetry-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-analytics-service:
    build:
      context: ./cloud-analytics-service
      dockerfile: Dockerfile
    ports:
      - "5124:8000"
    volumes:
      - ./cloud-analytics-service/app:/app/app:ro
    command: [ "python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000" ]
    environment:
      - LOG_LEVEL=DEBUG
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_analytics
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - BARN_RECORDS_SERVICE_URL=http://cloud-barn-records-service:3000
      - STANDARDS_SERVICE_URL=http://cloud-standards-service:3000
      - INSIGHTS_ORCHESTRATOR_ENABLED=true
      - LLM_INSIGHTS_BASE_URL=http://cloud-llm-insights-service:8000
      - READY_CHECK_LLM_INSIGHTS=true
      - LLM_TIMEOUT_S=10
      - LLM_MAX_RETRIES=1
      - ML_FALLBACK_ENABLED=false
      - ML_MODEL_BASE_URL=http://cloud-ml-model-service:8000
      - ML_TIMEOUT_S=4
      - ML_MAX_RETRIES=2
      - NOTIFICATIONS_ENABLED=true
      - NOTIFICATIONS_TIMEOUT_MS=2000
      - NOTIFICATION_SERVICE_URL=http://cloud-notification-service:3000
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-analytics-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      cloud-llm-insights-service:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-llm-insights-service:
    build:
      context: ./cloud-llm-insights-service
      dockerfile: Dockerfile
    ports:
      - "5134:8000"
    volumes:
      - ./cloud-llm-insights-service/app:/app/app:ro
    command: [ "python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000" ]
    environment:
      - LOG_LEVEL=DEBUG
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_llm_insights
      - LLM_PROVIDER=${LLM_PROVIDER:-mock}
      - LLM_TIMEOUT_S=${LLM_TIMEOUT_S:-10}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-1024}
      - LLM_MODEL=${LLM_MODEL:-gpt-4.1-mini}
      - PROMPT_VERSION=${PROMPT_VERSION:-v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-mock-key-for-development}
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-llm-insights-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-api-gateway-bff:
    build:
      context: ./cloud-api-gateway-bff
      dockerfile: Dockerfile
      target: development
    ports:
      - "5125:3000"
    volumes:
      - ./cloud-api-gateway-bff/src:/usr/src/app/src:ro
      - ./cloud-api-gateway-bff/package.json:/usr/src/app/package.json:ro
      - ./cloud-api-gateway-bff/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      # Prevent a single ts-node process from consuming all memory and getting OOM-killed under WSL/Docker Desktop.
      - NODE_OPTIONS=--max-old-space-size=256
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_api_gateway_bff
      - IDENTITY_BASE_URL=http://cloud-identity-access:3000
      - REGISTRY_BASE_URL=http://cloud-tenant-registry:3000
      - TELEMETRY_BASE_URL=http://cloud-telemetry-service:3000
      - ANALYTICS_BASE_URL=http://cloud-analytics-service:8000
      - WEIGHVISION_READMODEL_BASE_URL=http://cloud-weighvision-readmodel:3000
      - STANDARDS_SERVICE_URL=http://cloud-standards-service:3000
      - CLOUD_STANDARDS_SERVICE_URL=http://cloud-standards-service:3000
      - CONFIG_RULES_BASE_URL=http://cloud-config-rules-service:3000
      - AUDIT_LOG_BASE_URL=http://cloud-audit-log-service:3000
      - NOTIFICATION_BASE_URL=http://cloud-notification-service:3000
      - CLOUD_NOTIFICATION_SERVICE_URL=http://cloud-notification-service:3000
      - REPORTING_EXPORT_BASE_URL=http://cloud-reporting-export-service:3000
      - FEED_SERVICE_URL=http://cloud-feed-service:3000
      - BARN_RECORDS_SERVICE_URL=http://cloud-barn-records-service:3000
      - BILLING_SERVICE_URL=http://cloud-billing-service:3000
      - CLOUD_BILLING_SERVICE_URL=http://cloud-billing-service:3000
      - ADVANCED_ANALYTICS_BASE_URL=http://cloud-advanced-analytics:8000
      - CLOUD_ADVANCED_ANALYTICS_BASE_URL=http://cloud-advanced-analytics:8000
      - DATA_PIPELINE_BASE_URL=http://cloud-data-pipeline:8000
      - CLOUD_DATA_PIPELINE_BASE_URL=http://cloud-data-pipeline:8000
      - BI_METABASE_BASE_URL=http://cloud-bi-metabase:3000
      - CLOUD_BI_METABASE_BASE_URL=http://cloud-bi-metabase:3000
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-api-gateway-bff
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-config-rules-service:
    build:
      context: ./cloud-config-rules-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5126:3000"
    volumes:
      - ./cloud-config-rules-service/src:/usr/src/app/src:ro
      - ./cloud-config-rules-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-config-rules-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_config_rules
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-config-rules-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-audit-log-service:
    build:
      context: ./cloud-audit-log-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5127:3000"
    volumes:
      - ./cloud-audit-log-service/src:/usr/src/app/src:ro
      - ./cloud-audit-log-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-audit-log-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_audit_log
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-audit-log-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-notification-service:
    build:
      context: ./cloud-notification-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5128:3000"
    volumes:
      - ./cloud-notification-service/src:/usr/src/app/src:ro
      - ./cloud-notification-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-notification-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_notification
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - WORKER_CONCURRENCY=1
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-notification-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-reporting-export-service:
    build:
      context: ./cloud-reporting-export-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5129:3000"
    volumes:
      - ./cloud-reporting-export-service/src:/usr/src/app/src:ro
      - ./cloud-reporting-export-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-reporting-export-service/prisma:/usr/src/app/prisma:ro
      - report_exports_data:/data/exports
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_reporting_export
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - REPORT_DOWNLOAD_SECRET=${REPORT_DOWNLOAD_SECRET:-dev-report-secret}
      - EXPORT_ROOT=/data/exports
      - WORKER_CONCURRENCY=1
      - CLOUD_FEED_SERVICE_URL=http://cloud-feed-service:5130
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-reporting-export-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-feed-service:
    build:
      context: ./cloud-feed-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5130:3000"
    volumes:
      - ./cloud-feed-service/src:/usr/src/app/src:ro
      - ./cloud-feed-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-feed-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_feed
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-feed-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-barn-records-service:
    build:
      context: ./cloud-barn-records-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5131:3000"
    volumes:
      - ./cloud-barn-records-service/src:/usr/src/app/src:ro
      - ./cloud-barn-records-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-barn-records-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_barn_records
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-barn-records-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-weighvision-readmodel:
    build:
      context: ./cloud-weighvision-readmodel
      dockerfile: Dockerfile
      target: development
    ports:
      - "5132:3000"
    volumes:
      - ./cloud-weighvision-readmodel/src:/usr/src/app/src:ro
      - ./cloud-weighvision-readmodel/package.json:/usr/src/app/package.json:ro
      - ./cloud-weighvision-readmodel/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_weighvision_readmodel
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-weighvision-readmodel
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
      - DD_LOGS_INJECTION=true
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # สำหรับ Dev แค่นี้พอต่อการทำงานทั่วไป
          memory: 384M

  cloud-billing-service:
    build:
      context: ./cloud-billing-service
      dockerfile: Dockerfile
      target: development
    ports:
      - "5145:3000"
    volumes:
      - ./cloud-billing-service/src:/usr/src/app/src:ro
      - ./cloud-billing-service/package.json:/usr/src/app/package.json:ro
      - ./cloud-billing-service/prisma:/usr/src/app/prisma:ro
    environment:
      - NODE_ENV=development
      - APP_PORT=3000
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_billing
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-billing-service
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # For Dev environment
          memory: 384M

  cloud-advanced-analytics:
    build:
      context: ./cloud-advanced-analytics
      dockerfile: Dockerfile
    ports:
      - "5146:8000"
    volumes:
      - ./cloud-advanced-analytics/app:/app/app:ro
    command: [ "python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000" ]
    environment:
      - LOG_LEVEL=DEBUG
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_advanced_analytics
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-advanced-analytics
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.20'   # For Dev environment
          memory: 384M

  cloud-data-pipeline:
    build:
      context: ./cloud-data-pipeline
      dockerfile: Dockerfile
    ports:
      - "5147:8000"
    volumes:
      - ./cloud-data-pipeline:/app:ro
    environment:
      - LOG_LEVEL=DEBUG
      - PORT=8000
      - DATABASE_URL=postgresql://${POSTGRES_USER:-farmiq}:${POSTGRES_PASSWORD:-farmiq_dev}@postgres:5432/cloud_data_pipeline
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-farmiq}:${RABBITMQ_PASS:-farmiq_dev}@rabbitmq:5672
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-data-pipeline
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    networks:
      - farmiq-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

  cloud-bi-metabase:
    build:
      context: ./cloud-bi-metabase
      dockerfile: Dockerfile
    ports:
      - "5148:3000"
    environment:
      - MB_DB_FILE=/metabase-data/metabase.db
      - MB_JETTY_HOST=0.0.0.0
      - MB_JETTY_PORT=3000
      - DD_ENV=${DD_ENV:-dev}
      - DD_SERVICE=cloud-bi-metabase
      - DD_VERSION=${DD_VERSION:-local}
      - DD_AGENT_HOST=datadog
      - DD_TRACE_AGENT_PORT=8126
    volumes:
      - metabase_data:/metabase-data
    networks:
      - farmiq-net
    deploy:
      resources:
        limits:
          cpus: '1.0'    # ให้เยอะหน่อยเพราะตอน Start-up หนักมาก
          memory: 1024M  # Metabase มักไม่รันถ้า RAM ต่ำกว่า 1GB

networks:
  farmiq-net:
    external: true

volumes:
  postgres_data:
  pgadmin_data:
  rabbitmq_data:
  vault_data:
  report_exports_data:
  metabase_data:
